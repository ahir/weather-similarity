<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">

    html { height: 100% }
    body { height: 100%; margin: 0; padding: 0 }
  
    .container 
    { 
        height: 100%;
        width: 100%
    }

    .map_canvas 
    { 
        height: 100%
    }

    .sidebar 
    {
        margin-top: 1em;
        width: 300px;
        float: left;
        height: 100%;
        padding: 5px;
    }
    
</style>

    <script type="text/javascript" src="datadict.json"></script>
    <script type="text/javascript" src="distance.js"></script>

    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>
    
    <script type="text/javascript">
    
    function get(id)
    {
        return document.getElementById(id);
    }
    
    Array.prototype.contains = function(obj) 
    {
        var i = this.length;
        while (i--) 
        {
            if (this[i] === obj) 
            {
                return true;
            }
        }
        return false;
    }

    var SELECT_MODE = 0;
    var SHOW_MODE   = 1;
    
    var mode = SELECT_MODE;
    var map = null;
    var current_station = null;
    
    function init() 
    {
        var center = new google.maps.LatLng(37.257266,-122.03396);
        var options = {
            zoom: 9,
            center: center,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map_canvas"), options);
        
        createMarkers();
    }

    function createMarkers()
    {
        for(i in mapdict)
        {
             var x = mapdict[i];
             
             var marker = new google.maps.Marker({
                position: new google.maps.LatLng(x.Lat, -1*x.Long), 
                map: map, 
                title: x.Name
                }); 
              var infowindow = new google.maps.InfoWindow(
              { 
                content: x.Name,
                size: new google.maps.Size(50,50)
              });
              
              attachNumber(marker, x);
              x.Marker = marker;
        }
    }
  
  
    function attachNumber(marker, x) 
    {
        var infowindow = new google.maps.InfoWindow(
        { 
            content: x.Name + " " + x.Country  +" <br> " + " SOMETHING, SOMETHING",
            size: new google.maps.Size(50,50)
        });
        //TODO: maybe remember the window in global var and close if another one is selected
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map,marker);
            markerClicked(x.Number);
        });
    }
    
    function markerClicked(id)
    {
        if(mode == SELECT_MODE)
        {
            current_station_id = id; 
            get("current_station").innerHTML = mapdict[current_station_id].Name;
            get("change_button").disabled = false;
            
            //TODO: calculate closest stations
            
            var closest = ["724940", "723893"];
            
            hideDistantMarkers(closest);
            
            mode = SHOW_MODE;
        }
        else
        if(mode == SHOW_MODE)
        {
            //TODO: what to do here?
        }
    }
    
    function showAllMarkers()
    {
        for(i in mapdict)
        {
            mapdict[i].Marker.setVisible(true);
        }
    }
    
    function hideDistantMarkers(closest)
    {
        for(i in mapdict)
        {
            if(i == current_station_id)
            {
                mapdict[i].Marker.setIcon("http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png");
            }
            else
            if(closest.contains(i))
            {
                mapdict[i].Marker.setIcon("http://www.google.com/intl/en_us/mapfiles/ms/micons/green-dot.png");
            }
            else
                mapdict[i].Marker.setVisible(false);
        }
    }
    
    function changeStation()
    {
        mode = SELECT_MODE;
        get("change_button").disabled = true;
        showAllMarkers();
    }
    
    </script>

</head>

<body onload="init()">
    <div class="container">

    <div id="work_area" class="sidebar">
        <div>From:&nbsp;<span id="current_station"></span>&nbsp;
        <button id="change_button" type="button" disabled="false" onclick="change()">Change</button>
        </div>
    </div> 
    <div id="map_canvas" class="map_canvas"></div>
    
    </div>
</body>
</html>